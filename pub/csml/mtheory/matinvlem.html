<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/main.css"> <link rel=icon  href="/assets/infra/favicon.png"> <title>Matrix inversion lemmas</title> <header> <div class=blog-name ><a href="/">Thibaut Lienart</a></div> <nav> <ul> <li><a href="/">Home</a> <li><a href="/pub/csml.html">CS/ML notes</a> <li><a href="/pub/julia.html">Julia notes</a> <li><a href="/pub/misc.html">Misc.</a> </ul> <img src="/assets/infra/hamburger.svg" id=menu-icon > </nav> </header> <div class=jd-content > <h1>Matrix inversion lemmas</h1> <p>The <em>Woodbury formula</em> is maybe one of the most ubiquitous trick in basic linear algebra: it starts with the explicit formla for the inverse of a block 2x2 matrix and results in identities that can be used in kernel theory, the Kalman filter, to combine multivariate normals etc.</p> <h2>Partitioned matrix inversion</h2> <p>Consider an invertible matrix \(M\) made of blocks \(A\), \(B\), \(C\) and \(D\) with</p> $$ M \quad\!\! =\quad\!\! \begin{pmatrix} A & B \\ C & D \end{pmatrix} $$ <p>where both \(A\) and \(D\) are assumed to be square and invertible. The aim is to express the inverse of \(M\) in terms of the blocks \(A\), \(B\), \(C\) and \(D\) and the inverse of \(A\) and \(D\). We can write the inverse of \(M\) using an identical structure:</p> $$ M^{-1} \quad\!\! =\quad\!\! \begin{pmatrix} W & X \\ Y& Z \end{pmatrix}, $$ <p>for some \(W\), \(X\), \(Y\) and \(Z\) to be determined. Using \(MM^{-1} = \mathbf I\) since \(M\) is assumed to be invertible, we get the following system of equations:</p> $$ \begin{cases} AW + BY &=\quad\!\! \mathbf I \\ AX + BZ &=\quad\!\! \mathbf 0 \\ CW + DY &=\quad\!\! \mathbf 0 \\ CX + DZ &=\quad\!\! \mathbf I \end{cases} $$ <p>Left multiplying the first two equations by \(A^{-1}\) and the last two by \(D^{-1}\) and re-arranging a little gives <a id=ZVIu ></a>$$ \begin{cases} (\mathbf I - A^{-1} B D^{-1} C)W &=\quad\!\! A^{-1}\\ (\mathbf I - D^{-1} CA^{-1} B)Z &=\quad\!\! D^{-1}\\ \end{cases} \quad\text{and}\quad \begin{cases} X &=\quad\!\! -A^{-1} B Z\\ Y &=\quad\!\! -D^{-1} C W \end{cases} $$ <p>The first two equations can be further simplified using that \((E F)^{-1} = F^{-1} E^{-1}\) for square invertible matrices \(E\) and \(F\):</p> <a id=Scyv ></a>$$ \begin{cases} W &=\quad\!\! (A - BD^{-1} C)^{-1}\\ Z &=\quad\!\! (D - CA^{-1} B)^{-1} \end{cases} $$ <p>We started with \(MM^{-1} = \mathbf I\) but we could have started with \(M^{-1} M=\mathbf I\) of course. This gives an equivalent result but the form obtained for \(Y\) and \(X\) is different:</p> <a id=35AI ></a>$$ \begin{cases} Y &=\quad\!\! -ZCA^{-1}\\ X &=\quad\!\! -WBD^{-1} \end{cases} $$ <h3>Basic lemmas</h3> <p>Equating the expressions in <span class=eqref >(<a href="#ZVIu">4</a>)</span> and <span class=eqref >(<a href="#35AI">6</a>)</span> for \(Y\) gives \(D^{-1} CW = ZCA^{-1}\) which, combined with <span class=eqref >(<a href="#Scyv">5</a>)</span> gives the first lemma.</p> <div class=colbox-blue >&#40;<strong>Lemma I</strong>&#41; let \(A\) and \(D\) be square, invertible matrices of size \(n_A\times n_A\) and \(n_D\times n_D\) and \(B\) and \(C\) be matrices of size \(n_A\times n_D\) and \(n_D\times n_A\), the following identity holds: $$ D^{-1} C (A-BD^{-1} C)^{-1} \quad\!\! =\quad\!\! (D - CA^{-1} B)^{-1} CA^{-1}. $$</div> <p>Equating the expressions in <span class=eqref >(<a href="#ZVIu">4</a>)</span> and <span class=eqref >(<a href="#35AI">6</a>)</span> for \(X\) gives \(WBD^{-1} = A^{-1} B Z \) which, combined with <span class=eqref >(<a href="#Scyv">5</a>)</span> gives the second lemma.</p> <div class=colbox-blue >&#40;<strong>Lemma II</strong>&#41; under the same assumptions as for Lemma I, the following identity holds: <a id=eRt1 ></a>$$ (A - BD^{-1} C)^{-1} BD^{-1} \quad\!\! =\quad\!\! A^{-1} B (D - CA^{-1} B)^{-1}. $$</div> <h3>Woodbury formula</h3> <p>One little bit of dark magic is required to get the Woodbury formula &#40;also known as the <em>Sherman-Morrison-Woodbury formula</em>&#41;: observe that if we take the term \((A-BD^{-1} C)\) and right-multiply it by \(-A^{-1}\) we get</p> $$ (A-BD^{-1} C)(-A^{-1}) \quad\!\! =\quad\!\! \textcolor{green}{BD^{-1}}\textcolor{blue}{CA^{-1}} - \mathbf I $$ <p>and therefore \(BD^{-1} CA^{-1} = (I + (A-BD^{-1} C)(-A^{-1})\). Now if we post-multiply <span class=eqref >(<a href="#eRt1">8</a>)</span> by \(CA^{-1}\) and re-arrange the expression, we get the desired lemma.</p> <div class=colbox-blue >&#40;<strong>Woodbury formula</strong>&#41; under the same assumptions as for Lemma I, the following identity holds: $$ (A-BD^{-1} C)^{-1} \quad\!\! =\quad\!\! A^{-1} + A^{-1} B(D-CA^{-1} B)^{-1} CA^{-1}. $$</div> <p>of course the same gymnastics can be applied with the term \((D-CA^{-1} B)^{-1}\) to obtain</p> <div class=colbox-blue >$$ (D-CA^{-1} B)^{-1} \quad\!\! =\quad\!\! D^{-1} + D^{-1} C(A-BD^{-1} C)^{-1} BD^{-1}. $$</div> <h2>A bit of code</h2> <p>If you want to convince yourself that these equations &quot;work&quot;, here&#39;s a simple script that shows it at work:</p> <pre><code class=language-julia >using Test
using Random: seed&#33;
seed&#33;&#40;11325&#41;
n_A &#61; 15; n_D &#61; 7;
A &#61; randn&#40;n_A, n_A&#41;;
B &#61; randn&#40;n_A, n_D&#41;;
C &#61; randn&#40;n_D, n_A&#41;;
D &#61; randn&#40;n_D, n_D&#41;;
iA, iD &#61; inv&#40;A&#41;, inv&#40;D&#41;;
@test inv&#40;A-B*iD*C&#41; ≈ iA &#43; iA*B*inv&#40;D-C*iA*B&#41;*C*iA
@test inv&#40;D-C*iA*B&#41; ≈ iD &#43; iD*C*inv&#40;A-B*iD*C&#41;*B*iD</code></pre> <p>Where we profit from the fact that invertible matrices are dense among square matrices so that there&#39;s little chance that <code>A</code> and <code>D</code> are not invertible in the script above for a given seed. <div class=page-foot > <div class=copyright > &copy; T. Lienart. Last modified: December 12, 2018. Website built with <a href="https://github.com/tlienart/JuDoc.jl">JuDoc.jl</a>. </div> </div> </div> <script src="/libs/katex/katex.min.js"></script> <script src="/libs/katex/auto-render.min.js"></script> <script>renderMathInElement(document.body)</script> <script src="/libs/highlight/highlight.pack.js"></script> <script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: ' '});</script>